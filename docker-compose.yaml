services:

  app:
    build: ./optimisation
    container_name: typescript_app
    networks:
      - crazy-charly.net
    secrets:
      - db_user
      - db_password
      - db_name
    environment:
      - DB_HOST=db
      - DB_USER_FILE=/run/secrets/db_user
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - DB_NAME_FILE=/run/secrets/db_name
    volumes:
      - ./input_csv:/input_csv # pour les imports CSV
      - ./output_csv:/output_csv # pour les exports CSV
    command: /bin/sh -c "npm start && echo '--- Script termin√©, le conteneur reste actif ---' && tail -f /dev/null"

  db:
    image: postgres:15-alpine
    restart: always
    ports:
      - 5432:5432
    environment:
      - POSTGRES_USER_FILE=/run/secrets/db_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - POSTGRES_DB_FILE=/run/secrets/db_name
    secrets:
      - db_user
      - db_password
      - db_name
    networks:
      - crazy-charly.net
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U app_user -d crazy_charly_db" ]
      interval: 5s
      timeout: 5s
      retries: 5

  crazy-charly-web:
    platform: linux/amd64
    build:
      context: ./crazy-charly-web
      dockerfile: Dockerfile
    ports:
      - 3000:3000
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./crazy-charly-web:/app:delegated
      - crazy-charly-web-node-modules:/app/node_modules
      - crazy-charly-next:/app/.next
    networks:
      - crazy-charly.net
    environment:
      - PORT=3000
      - DATABASE_URL=postgresql://app_user:password@db:5432/crazy_charly_db?schema=public
      - AUTH_SECRET=${AUTH_SECRET}
      - NEXTAUTH_SECRET=${AUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
    restart: unless-stopped
    secrets:
      - db_user
      - db_password
      - db_name
networks:
  crazy-charly.net:
    driver: bridge

volumes:
  postgres-data:
  crazy-charly-web-node-modules:
  crazy-charly-next:

secrets:
  db_root_password:
    file: ./secrets/db_root_password.txt
  db_password:
    file: ./secrets/db_password.txt
  db_user:
    file: ./secrets/db_user.txt
  db_name:
    file: ./secrets/db_name.txt
