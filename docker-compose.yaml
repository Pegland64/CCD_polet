services:

  ###################
  # Backend Python  #
  ###################

  app:
    build: ./optimisation
    container_name: typescript_app
    networks:
      - ccd_network
    secrets:
      - db_user
      - db_password
      - db_name
    environment:
      - DB_HOST=mariadb
      - DB_USER_FILE=/run/secrets/db_user
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - DB_NAME_FILE=/run/secrets/db_name
    volumes:
      - ./input_csv:/input_csv # pour les imports CSV
      - ./output_csv:/output_csv # pour les exports CSV
    command: /bin/sh -c "npm start && echo '--- Script termin√©, le conteneur reste actif ---' && tail -f /dev/null"

  mariadb:
    image: mariadb:latest
    container_name: mariadb_container
    restart: unless-stopped
    secrets:
      - db_root_password
      - db_password
      - db_user
      - db_name
    environment:
      - MARIADB_ROOT_PASSWORD_FILE=/run/secrets/db_root_password
      - MARIADB_USER_FILE=/run/secrets/db_user
      - MARIADB_PASSWORD_FILE=/run/secrets/db_password
      - MARIADB_DATABASE_FILE=/run/secrets/db_name
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./initdb:/docker-entrypoint-initdb.d
    networks:
      - ccd_network

secrets:
  db_root_password:
    file: ./secrets/db_root_password.txt
  db_password:
    file: ./secrets/db_password.txt
  db_user:
    file: ./secrets/db_user.txt
  db_name:
    file: ./secrets/db_name.txt

###################
# Networks        #
###################

volumes:
  mariadb_data:


networks:
  ccd_network:
    driver: bridge
